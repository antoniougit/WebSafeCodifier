<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Encode problematic characters for web and email. Replaces them with hex entities based on options. Also encodes & decodes Persado Web Standalone config."
    />
    <meta name="robots" content="noindex,nofollow" />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <title>WebSafe Codifier</title>
    <!-- prettier-ignore -->
    <style>
      #container,.buttons{display:-webkit-box;display:-ms-flexbox}.content,body{background-color:#f4f4f4}main,textarea{width:100%}body,textarea{font-family:Arial,sans-serif}.checkbox-label,label{font-weight:600}body{margin:0;padding:0}.content,header{margin-bottom:20px}#container{display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:20px;background-color:#fff;border-radius:10px;-webkit-box-shadow:0 0 10px rgba(0,0,0,.1);box-shadow:0 0 10px rgba(0,0,0,.1);margin:50px auto;max-width:800px}.content,textarea{border:1px solid #c4c4c4}header{text-align:center}.content{padding:20px;border-radius:10px}h3{margin-bottom:10px}textarea{border-radius:5px;resize:vertical}.buttons{margin-top:20px;display:flex;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}p{margin:10px 0;color:#888}.checks{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:5px 0;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.checkbox-input{margin-right:10px;cursor:pointer;appearance:none;-webkit-appearance:none;-moz-appearance:none;width:18px;height:18px;border:1px solid #c4c4c4;border-radius:3px;background-color:#fff;-webkit-transition:background-color .3s ease-in-out;-o-transition:background-color .3s ease-in-out;transition:background-color .3s ease-in-out}.checkbox-input:checked{background-color:red;border:1px solid red}.checkbox-label{cursor:pointer}
    </style>
  </head>

  <body>
    <div id="container">
      <header>
        <h1>WebSafe Codifier</h1>
        <h2>
          <span style="color: red">[ </span>George Antoniou - EMEA SDE team<span
            style="color: red"
            >]</span
          >
        </h2>
      </header>
      <main>
        <div class="content">
          <div id="inputBox">
            <h3>Input:</h3>
            <span id="inputCounter" name="inputCounter">0 chars</span>
            <textarea id="input" name="input" rows="10"></textarea>
          </div>
          <div id="options">
            <div class="checks">
              <input type="checkbox" id="web" class="checkbox-input" />
              <label for="web" class="checkbox-label" style="color: red"
                >Encode or decode config for Web Standalone (overrides ALL other
                options)</label
              >
            </div>
            <div class="checks">
              <input type="checkbox" id="xml" class="checkbox-input" />
              <label for="xml" class="checkbox-label"
                >Replace &lt; &gt; &quot; &amp; &apos; with named
                entities</label
              >
            </div>
            <div class="checks">
              <input type="checkbox" id="nbsp" class="checkbox-input" />
              <label for="nbsp" class="checkbox-label"
                >Replace spaces with &amp;nbsp;</label
              >
            </div>
            <div class="checks">
              <input type="checkbox" id="br" class="checkbox-input" />
              <label for="br" class="checkbox-label"
                >Replace newlines with &lt;br /&gt;</label
              >
            </div>
            <div class="checks">
              <input type="checkbox" id="all" class="checkbox-input" />
              <label for="all" class="checkbox-label" style="color: blue"
                >Encode ALL except standard chars (overrides 3 above
                options)</label
              >
            </div>
          </div>
        </div>
        <div class="content">
          <div id="outputBox">
            <h3>Output:</h3>
            <span id="outputCounter" name="outputCounter">0 chars</span>
            <textarea id="output" name="output" rows="10"></textarea>
          </div>
        </div>
      </main>
    </div>
    <script>
      function encodeText() {
        try {
          const input = document.getElementById('input'),
            output = document.getElementById('output'),
            checkWeb = document.getElementById('web'),
            checkXML = document.getElementById('xml'),
            checkNbsp = document.getElementById('nbsp'),
            checkBr = document.getElementById('br'),
            checkAll = document.getElementById('all');

          let encoded = input.value;

          if (encoded.trim() === '') {
            clearTexts();
            throw new Error('Input is empty');
          }

          if (checkWeb.checked) {
            if (encoded.includes('{')) {
              encoded = encoded
                .split('PersadoCode.init(')
                .pop()
                .replace(/\)\s*$/, '');
              eval('encoded = ' + encoded);
              encoded = btoa(JSON.stringify(encoded));
            } else {
              encoded = atob(encoded);
              if (encoded.includes('\\n')) {
                encoded = JSON.parse(encoded);
              } else {
                encoded = JSON.stringify(JSON.parse(encoded), null, 2);
              }
            }
          } else {
            const xmlMap = {
              0x3c: '&lt;',
              0x3e: '&gt;',
              0x22: '&quot;',
              0x26: '&amp;',
              0x27: '&apos;',
            };

            encoded = encoded.replace(
              /([\u0000-\uD799]|[\uD800-\uDBFF][\uDC00-\uFFFF])/g,
              function (c) {
                let c1 = c.charCodeAt(0);
                if (!checkAll.checked) {
                  if (c1 === 0x20) return checkNbsp.checked ? '&nbsp;' : c;
                  if (c1 === 0x0a) return checkBr.checked ? '<br />' : c;
                  if (checkXML.checked && xmlMap[c1]) return xmlMap[c1];
                }
                if (c1 >= 0x20 && c1 <= 0x7e) return c;
                else if (c.length === 1) return `&#x${c1.toString(16)};`;
                else if (c.length === 2 && c1 >= 0xd800 && c1 <= 0xdbff)
                  return `&#x${(
                    (c1 - 0xd800) * 0x400 +
                    c.charCodeAt(1) -
                    0xdc00 +
                    0x10000
                  ).toString(16)};`;
                else return '';
              }
            );
          }

          output.value = encoded;
          document.getElementById('inputCounter').textContent =
            input.value.length + ' chars';
          document.getElementById('outputCounter').textContent =
            output.value.length + ' chars';
        } catch (error) {
          clearTexts();
          if (error.message.includes('atob')) {
            alert('Invalid Standalone config');
          } else {
            alert(error.message);
          }
        }
      }

      function encodeOnInput() {
        encodeText();
      }

      function onCheckboxChange() {
        encodeText();
      }

      function clearTexts() {
        document.getElementById('input').value = '';
        document.getElementById('output').value = '';
        document.getElementById('inputCounter').textContent = '0 chars';
        document.getElementById('outputCounter').textContent = '0 chars';
        uncheckAllCheckboxes();
      }

      function uncheckAllCheckboxes() {
        const checkboxes = document.querySelectorAll('.checkbox-input');

        checkboxes.forEach((checkbox) => {
          checkbox.checked = false;
        });
      }

      document
        .getElementById('input')
        .addEventListener('input', encodeOnInput, false);

      const checkboxes = document.querySelectorAll('.checkbox-input');
      for (const checkbox of checkboxes) {
        checkbox.addEventListener('change', onCheckboxChange);
      }

      clearTexts();
    </script>
  </body>
</html>
